// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Using PostgreSQL - supports all Prisma features

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password      String
  emailVerified Boolean   @default(true)
  role          String    @default("agent") // "admin" or "agent"
  referralCode  String    @unique
  uplineId      String?
  level         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  upline        User?     @relation("UplineDownline", fields: [uplineId], references: [id])
  downlines     User[]    @relation("UplineDownline")
  sales         Sale[]
  commissions   Commission[]
  wallet        Wallet?
  withdrawals   Withdrawal[]
  bankDetails   BankDetails?
  visits        Visit[]

  @@index([uplineId])
  @@index([referralCode])
}

model Property {
  id                    String    @id @default(uuid())
  name                  String
  location              String
  price                 Float
  description           String    // SQLite doesn't support @db.Text
  images                String    @default("[]") // Store as JSON string: "[\"url1\", \"url2\"]"
  totalCommissionPercent Float     // Total commission percentage reserved for all levels (e.g., 40%)
  sellerPercent         Float     // Commission % for seller (Level 0)
  level1Percent         Float     // Commission % for Level 1
  level2Percent         Float     // Commission % for Level 2
  level3Percent         Float     @default(0) // Commission % for Level 3
  level4Percent         Float     @default(0) // Commission % for Level 4
  level5Percent         Float     @default(0) // Commission % for Level 5
  level6Percent         Float     @default(0) // Commission % for Level 6
  status                String    @default("active") // active, inactive
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  sales                 Sale[]
  visits                Visit[]

  @@index([status])
}

model Sale {
  id              String      @id @default(uuid())
  propertyId      String
  sellerId        String
  buyerName       String
  buyerContact    String
  saleAmount      Float
  status          String      @default("pending") // "pending", "approved", "rejected"
  isViewedByAdmin Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  property        Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  seller          User        @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  commissions     Commission[]

  @@index([sellerId])
  @@index([propertyId])
  @@index([status])
  @@index([isViewedByAdmin])
}

model Commission {
  id              String            @id @default(uuid())
  saleId          String
  userId          String
  level           Int               // 0 = seller, 1 = upline, 2 = upline's upline
  percentage      Float
  amount          Float
  status          String            @default("pending") // "pending", "approved", "rejected"
  isViewedByAdmin Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  sale            Sale              @relation(fields: [saleId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([userId])
  @@index([status])
  @@index([isViewedByAdmin])
}

model Wallet {
  id              String   @id @default(uuid())
  userId          String   @unique
  balance         Float    @default(0)
  pendingBalance  Float    @default(0)
  approvedBalance Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BankDetails {
  id                String      @id @default(uuid())
  userId            String      @unique
  bankName          String
  accountHolderName String
  accountNumber     String
  ifscCode          String
  email             String
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  withdrawals       Withdrawal[]

  @@index([userId])
}

model Withdrawal {
  id              String            @id @default(uuid())
  userId          String
  bankDetailsId   String?
  amount          Float
  status          String            @default("pending") // "pending", "approved", "rejected"
  isViewedByAdmin Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankDetails     BankDetails?      @relation(fields: [bankDetailsId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([bankDetailsId])
  @@index([isViewedByAdmin])
}

model Visit {
  id               String    @id @default(uuid())
  agentId          String
  customerName     String
  customerContact  String
  photoUrl         String    // Can be a public URL or a data URL
  visitMode        String    // "company" | "self"
  propertyId       String
  meetingBy        String    // e.g. "Company Staff"
  meetingByName    String    @default("") @map("meeting_by_name") // Free-text company staff name entered by agent
  numberOfPeople   Int
  status           String    @default("submitted") // "submitted", "reviewed", etc.
  isViewedByAdmin  Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  agent            User      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  property         Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([propertyId])
  @@index([status])
  @@index([isViewedByAdmin])
}

model EmailVerification {
  id                String   @id @default(uuid())
  name              String
  email             String   @unique
  password          String   // Hashed password
  referralCodeInput String?
  uplineId          String?
  level             Int      @default(0)
  otp               String
  otpExpiresAt      DateTime
  createdAt         DateTime @default(now())
}

model PasswordReset {
  id           String   @id @default(uuid())
  email        String   @unique
  otp          String
  otpExpiresAt DateTime
  createdAt    DateTime @default(now())
}
